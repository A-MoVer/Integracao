name: CI Pipeline

on:
  pull_request:
    branches:
      - testes  # Executa apenas quando hÃ¡ um PR para 'testes'

permissions:
  contents: write
  pull-requests: write

jobs:
  code_quality:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout CÃ³digo
        uses: actions/checkout@v3

      - name: Executar AnÃ¡lise Codacy
        run: |
          export CODACY_PROJECT_TOKEN=${{ secrets.CODACY_PROJECT_TOKEN }}
          bash <(curl -Ls https://coverage.codacy.com/get.sh) analyze

  notify_codacy_issues:
    needs: code_quality
    if: failure()
    runs-on: ubuntu-latest

    steps:
      - name: Comentar no Pull Request com os Erros do Codacy
        run: |
          gh pr comment ${{ github.event.pull_request.html_url }} --body "
          ğŸš¨ Foram encontrados problemas de qualidade no cÃ³digo pela anÃ¡lise do Codacy!

          ğŸ“Œ Verifica os detalhes aqui: [Codacy Report](https://app.codacy.com/gh/A-MoVer/Integracao/issues)

          âš ï¸ Os desenvolvedores devem corrigir os problemas antes do merge para `testes`."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create_codacy_issue:
    needs: code_quality
    if: failure()
    runs-on: ubuntu-latest

    steps:
      - name: Criar um Issue no GitHub com os Erros do Codacy
        run: |
          gh issue create --title "ğŸš¨ Problemas de Qualidade do CÃ³digo no PR #${{ github.event.pull_request.number }}" \
                          --body "O Codacy detetou problemas de qualidade no cÃ³digo.  
                          ğŸ“Œ [Ver RelatÃ³rio do Codacy](https://app.codacy.com/gh/A-MoVer/Integracao/issues)  
                          âš ï¸ Os desenvolvedores devem corrigir antes do merge para `testes`." \
                          --label "Codacy Issues"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  auto_merge_testes:
    needs: code_quality
    if: success()
    runs-on: ubuntu-latest

    steps:
      - name: Merge AutomÃ¡tico para 'testes' se Codacy Aprovar
        run: |
          gh pr merge ${{ github.event.pull_request.html_url }} --auto --squash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
  notify_teams:
        needs: [code_quality, auto_merge_testes]
        if: always()
        runs-on: ubuntu-latest

        steps:
        - name: Obter Autor do Pull Request
          run: echo "PR_AUTHOR=${{ github.event.pull_request.user.login }}" >> $GITHUB_ENV

        - name: Definir Mensagem de NotificaÃ§Ã£o
          run: |
            if [[ "${{ needs.code_quality.result }}" == "success" && "${{ needs.auto_merge_testes.result }}" == "success" ]]; then
              MESSAGE="âœ… O Codacy nÃ£o encontrou problemas! O merge pode continuar. ğŸš€\n\nğŸ‘¤ Autor: $PR_AUTHOR"
            else
              MESSAGE="ğŸš¨ O Codacy encontrou problemas de qualidade no cÃ³digo! ğŸ“Œ Ver relatÃ³rio: https://app.codacy.com/gh/A-MoVer/Integracao/issues\nâš ï¸ Os desenvolvedores devem corrigir antes do merge para 'testes'.\n\nğŸ‘¤ Autor: $PR_AUTHOR"
            fi

            curl -H "Content-Type: application/json" -d "{\"text\": \"$MESSAGE\"}" "${{ secrets.TEAMS_WEBHOOK_URL }}"

  require_approval_develop:
    needs: auto_merge_testes
    runs-on: ubuntu-latest

    steps:
      - name: Requer AprovaÃ§Ã£o Manual para Merge em 'develop'
        run: echo "ğŸš€ Merge para 'develop' requer 2 aprovaÃ§Ãµes antes de continuar."
