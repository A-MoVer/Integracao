name: CI Pipeline

on:
  pull_request:
    branches:
      - '**'

permissions:
  contents: write
  pull-requests: write

jobs:
  code_quality:
    runs-on: ubuntu-latest
    steps:
      - name: Executar AnÃ¡lise Codacy
        run: echo "CODACY_PROJECT_TOKEN=\"${{ secrets.CODACY_PROJECT_TOKEN }}\"" >> $GITHUB_ENV
          bash <(curl -Ls https://coverage.codacy.com/get.sh) analyze --min-severity Medium || exit 1


  notify_codacy_issues:
    needs: code_quality
    if: failure()
    runs-on: ubuntu-latest

    steps:
      - name: Comentar no Pull Request com os Erros do Codacy
        run: |
          AUTHOR="${{ github.event.pull_request.user.login }}"
          gh pr comment ${{ github.event.pull_request.html_url }} --body "
          ðŸš¨ Foram encontrados problemas de qualidade no cÃ³digo!  

          ðŸ“Œ [Ver RelatÃ³rio do Codacy](https://app.codacy.com/gh/A-MoVer/Integracao/issues)  

          âš ï¸ Erros devem ser corrigidos antes do merge. ðŸ‘¤ Autor: @$AUTHOR"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  auto_merge_testes:
    needs: code_quality
    if: needs.code_quality.result == 'success'
    runs-on: ubuntu-latest


    steps:
      - name: Merge AutomÃ¡tico para a Branch de Destino se Codacy Aprovar
        run: |
          gh pr merge ${{ github.event.pull_request.html_url }} --auto --squash || gh pr merge ${{ github.event.pull_request.html_url }} --admin --squash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify_teams:
    needs: [code_quality, auto_merge_testes]
    if: always() && github.event.pull_request != ''
    runs-on: ubuntu-latest

    steps:
      - name: Definir Mensagem de NotificaÃ§Ã£o
        run: |
          set -x  # Modo debug para ver o que acontece
          echo "Iniciando notificaÃ§Ã£o do Teams..."
          BRANCH="${{ github.event.pull_request.base.ref }}"
          AUTHOR="${{ github.event.pull_request.user.login }}"
          
          echo "Branch: $BRANCH"
          echo "Author: $AUTHOR"
          echo "Code Quality Result: ${{ needs.code_quality.result }}"
          echo "Auto Merge Result: ${{ needs.auto_merge_testes.result }}"
      
          if [[ "${{ needs.code_quality.result }}" == "success" && "${{ needs.auto_merge_testes.result }}" == "success" ]]; then
            MESSAGE="âœ… Nenhum erro encontrado. CÃ³digo foi mesclado na branch '$BRANCH'. ðŸ‘¤ Autor: @$AUTHOR"
          else
            MESSAGE="ðŸš¨ Problemas de qualidade no cÃ³digo na branch '$BRANCH'!  
            ðŸ“Œ [Ver RelatÃ³rio do Codacy](https://app.codacy.com/gh/A-MoVer/Integracao/issues)  
            âš ï¸ Erros devem ser corrigidos antes do merge. ðŸ‘¤ Autor: @$AUTHOR"
          fi
      
          echo "Enviando notificaÃ§Ã£o para o Teams..."
          curl -v -H "Content-Type: application/json" -d "{\"text\": \"$MESSAGE\"}" "${{ secrets.TEAMS_WEBHOOK_URL }}"


  require_approval_develop:
    needs: auto_merge_testes
    runs-on: ubuntu-latest

    steps:
      - name: Requer AprovaÃ§Ã£o Manual para Merge em 'develop'
        run: echo "ðŸš€ Merge para 'develop' requer 2 aprovaÃ§Ãµes antes de continuar."
