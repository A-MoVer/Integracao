name: CI/CD Pipeline

on:
  pull_request:
    branches:
      - testes  # Executa apenas quando há um PR para 'testes'

jobs:
  code_quality:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Código
        uses: actions/checkout@v3

      - name: Executar Análise Codacy
        run: |
          export CODACY_PROJECT_TOKEN=${{ secrets.CODACY_PROJECT_TOKEN }}
          bash <(curl -Ls https://coverage.codacy.com/get.sh) report -l JavaScript

  auto_merge_testes:
    needs: code_quality
    if: success()
    runs-on: ubuntu-latest

    steps:
      - name: Merge Automático para 'testes' se Codacy Aprovar
        run: |
          gh pr merge ${{ github.event.pull_request.html_url }} --auto --squash --admin
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  auto_merge_develop:
    needs: auto_merge_testes
    if: success()
    runs-on: ubuntu-latest

    steps:
      - name: Merge Automático para 'develop' após 'testes'
        run: |
          git fetch origin
          git checkout develop
          git merge --no-ff testes -m 'Merge automático após testes'
          git push origin develop
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
